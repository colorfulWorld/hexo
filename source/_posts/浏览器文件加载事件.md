---
title: 浏览器文件加载事件
date: 2018-05-17 09:47:28
categories: HTML5
---

以前在项目中遇到过‘监听浏览器的前进后退重新执行 JS’的需求的场景，所以现在综合一些资料和自己的测试进行总结一下。

<!--more-->

## 渲染机制

浏览器的渲染机制一般分为以下几个步骤

1. 处理 HTML 并构建 DOM 树
   2。

## 浏览器前进、后退使用机制

用户点击浏览器工具栏中的后退按钮，或者是移动设备上的返回键的时候，或者是 JS 执行`history.go(-1)`的时候，浏览器会在当前窗口“打开”历史记录中的前一个页面。不同的浏览器在“打开”前一个页面的表现并不同意，这和浏览器的实现以及页面本身的设置都有关系。在浏览器中，“后退到前一个页面”意味着：前一个页面的 html/js/css 等等的静态资源的请求（甚至是 ajax 动态接口请求）根本不会重新发送，直接使用缓存的响应，而不管这些金泰资源响应的缓存策略是否被设置了禁用状态。

---

## history 中的操作

1.  `window.history.back()`:后退
2.  `window.history.dorward()`:前进
3.  `window.history.go(num)`:前进或后退指定数量历史记录
4.  `window.history.pushState(state,title,url)`:在页面中创建一个 histor 实体，直接天剑到历史记录。
    - state:存储一个对象，可以添加相关信息，可以使用 history.state 读取其中的内容。
    - title:历史记录的标题。
    - url:创建的历史记录的链接，进行历史记录操作时会跳转到改链接。
5.  `window.history.replaceState()`:修改当前的 history 实体。
6.  `popstate`事件:history 实体改变时触发的事件。
7.  `window.history.state`:会获得 history 实体中的 state 对象。

## popstate

popstate 只会在浏览器某些行为下触发，比如点击后退、前进按钮。

在微信浏览器中，从一个 HTML 跳到另一个 HTML 页面后，点击浏览器返回按钮，或者在第二个页面中调用`history.back()`等返回上一页的方法，在安卓中会直接返回上一页(相当于重新加载上一页的所有内容，js 会重新执行一遍)，但苹果手机中，范湖上一页是，浏览器会读取缓存中的页面内容，js 不会重新执行，在此进入这个页面不会触发 onload 事件。

```javascript
//强制刷新：
window.addEventListener(
  'popstate',
  function(e) {
    //检测到用户点击浏览器返回按钮，进行操作
    console.log(document.referrer);

    //使用href的形式去用跳转的形式，跳转到上一页
    document.location.href = document.referrer;
  },
  false
);
var state = {
  title: '',
  url: ''
};
window.history.pushState(state, '', '');
```

## pageshow

onpageshow 事件在页面显示时触发，如果页面不在“往返缓存”中，改时间会在 onload 后触发，在 onpageshow 事件中，可以利用 event.persisted

```javascript
    window.addEventListener('pageshow'.function(evernt){
        alert(event.persisted);
        if(event.persisted) location.reload();//如果检测到页面是从“往返缓存”中读取的，刷新页面。
    });
```

## unload

指定 unload 事件处理程序的页面会被自动排除在“往返缓存”之外，即使事件处理程序是空白的，原因在于，unload 最长用于撤销 load 中所执行的操作，而跳过 load 后再次显示页面很有可能会导致页面不正常。
